# 写中断程序要注意哪些方面？

与每类 I/O 设备相关的进程都有一个靠近内存底部的地址，称作中断向量。它包括中断服务程序的入口地址。

当中央处理器正在处理内部数据时，外界发生了紧急情况，要求 CPU 暂停当前的工作转去处理这个紧急事件。处理完毕后，再回到原来被中断的地址，继续原来的工作，这样的过程称为中断。

## 中断处理过程

- 保护被中断进程现场。为了在中断处理结束后能够使进程准确地返回到中断点，系统必须保存当前处理机程序状态字 PSW 和程序计数器 PC 等的值。
- 分析中断原因，转去执行相应的中断处理程序。在多个中断请求同时发生时，处理优先级最高的中断源发出的中断请求。
- 恢复被中断进程的现场，CPU 继续执行原来被中断的进程。

## 三个大注意事项

- 中断函数代码应尽量简洁。一般不宜在中断函数内编写大量复杂冗长的代码；应尽量避免在中断函数内调用其他自定义函数；
- 尽量避免在中断内调用数学函数。因为某些数学函数涉及相关的库函数调用和中间变量较多，可能出现交叉调用。在必须使用数学函数时，可考虑将复杂的数学函数运算任务交给主程序完成，中断函数通过全局变量引用其结果；
- 宏的定义与调用。在中断函数中调用宏，可减少在函数调用中压栈与出栈的开销。

## 九个小注意事项

- 中断函数不能进行参数传递
- 中断函数没有返回值
- 在任何情况下都不能直接调用中断函数
- 中断函数使用浮点运算要保存浮点寄存器的状态。
- 如果在中断函数中调用了其它函数，则被调用函数所使用的寄存器必须与中断函数相同，被调函数最好设置为可重入的。
- （可忽略）C51 编译器对中断函数编译时会自动在程序开始和结束处加上相应的内容，具体如下：
  - 在程序开始处对 ACC、B、DPH、DPL 和 PSW 入栈，结束时出栈。
  - 中断函数未加 using n 修饰符的，开始时还要将 R0~R1 入栈，结束时出栈。
  - 如中断函数加 using n 修饰符，则在开始将 PSW 入栈后还要修改 PSW 中的工作寄存器组选择位。
  - C51 编译器从绝对地址 8n+3 处产生一个中断向量，其中 n 为中断号，也即 interrupt 后面的数字。该向量包含一个到中断函数入口地址的绝对跳转。
- 中断函数最好写在文件的尾部，并且禁止使用 extern 存储类型说明。防止其它程序调用。
- 在设计中断时，要注意的是哪些功能应该放在中断程序中，哪些功能应该放在主程序中。一般来说中断服务程序应该做最少量的工作，这样做有很多好处。
  - 首先系统对中断的反应面更宽了，有些系统如果丢失中断或对中断反应太慢将产生十分严重的后果，这时有充足的时间等待中断是十分重要的。
  - 其次它可使中断服务程序的结构简单，不容易出错。中断程序中放入的东西越多，他们之间越容易起冲突。简化中断服务程序意味着软件中将有更多的代码段，但可把这些都放入主程序中。
- 中断服务程序的设计对系统的成败有至关重要的作用，要仔细考虑各中断之间的关系和每个中断执行的时间，特别要注意那些对同一个数据进行操作的中断
